# 📋 2단계 개선 계획: 청크 분할 + 표 전용 처리

## 🎯 목표

현재 남은 2개 TOC 페이지 처리 + 전반적인 번역 품질 향상

---

## 📊 현재 상황 분석

### ✅ 해결된 문제
- API 재시도 실패: 100% 해결
- 타입 에러: 100% 해결
- 일반 텍스트 번역: 100% 성공

### 🟡 남은 문제
- TOC 페이지 2개 (페이지 2, 3)
- 복잡한 구조의 완전한 처리 필요

---

## 🔧 2단계 개선사항 설계

### 1. 스마트 청크 분할 전략

#### 목적
- 긴 텍스트를 의미 있는 단위로 분할
- 컨텍스트 손실 최소화
- 번역 품질 향상

#### 전략
```python
1. 텍스트 길이 분석
   - 짧음 (<800자): 그대로 처리
   - 중간 (800-2000자): 의미 기반 분할
   - 긺 (2000자+): 강제 분할

2. 분할 기준 (우선순위)
   - 단락 구분 (\n\n)
   - 문장 끝 (。！？.)
   - 쉼표 (，,)
   - 고정 길이 (최후 수단)

3. 오버랩 전략
   - 앞뒤 100자씩 오버랩
   - 컨텍스트 유지
   - 자연스러운 연결
```

### 2. 표/테이블 전용 처리

#### 목적
- 표 구조 감지 및 보존
- 셀 내용 정확한 번역
- 포맷 유지

#### 전략
```python
1. 표 감지 알고리즘
   - 패턴 기반: ┃│├─ 등 표 문자
   - 구조 기반: 반복되는 행/열 패턴
   - 키워드 기반: "表", "系统", "功能" 등

2. 표 전용 처리
   - 셀별로 분리 번역
   - 구조 정보 보존
   - 재조립 로직

3. Markdown 변환
   - PDF 표 → Markdown 표
   - 번역
   - 원본 형식으로 복원
```

### 3. TOC 전용 처리

#### 목적
- 복잡한 목차 구조 완전 번역
- 페이지 번호 유지
- 계층 구조 보존

#### 전략
```python
1. TOC 구조 분석
   - 들여쓰기 레벨 파악
   - 항목 번호 추출
   - 페이지 번호 분리

2. 항목별 번역
   - 각 목차 항목 개별 번역
   - 번호와 페이지는 유지
   - 재조립

3. 검증 및 후처리
   - 계층 구조 확인
   - 누락 항목 체크
```

---

## 📝 단계별 실행 계획

### Step 1: 청크 분할 구현 ⏱️ 30분

**작업 내용**:
- [x] 텍스트 길이 분석 함수
- [ ] 스마트 분할 알고리즘
- [ ] 오버랩 처리 로직
- [ ] 청크 재조립 함수

**예상 코드**:
```python
def smart_chunk_text(text: str, max_length: int = 800, overlap: int = 100):
    """스마트 청크 분할"""
    pass

def merge_chunks(chunk_translations: List[str]) -> str:
    """청크 재조립"""
    pass
```

### Step 2: 표 감지 및 처리 ⏱️ 45분

**작업 내용**:
- [ ] 표 패턴 감지
- [ ] 표 구조 파싱
- [ ] Markdown 변환
- [ ] 셀별 번역
- [ ] 재조립

**예상 코드**:
```python
def detect_table(text: str) -> bool:
    """표 감지"""
    pass

def process_table(text: str) -> str:
    """표 전용 처리"""
    pass
```

### Step 3: TOC 전용 처리 ⏱️ 45분

**작업 내용**:
- [ ] TOC 구조 파싱
- [ ] 항목별 분리
- [ ] 개별 번역
- [ ] 재조립

**예상 코드**:
```python
def parse_toc(text: str) -> List[dict]:
    """TOC 구조 파싱"""
    pass

def process_toc(toc_items: List[dict]) -> str:
    """TOC 전용 처리"""
    pass
```

### Step 4: 통합 및 테스트 ⏱️ 30분

**작업 내용**:
- [ ] 모든 로직 통합
- [ ] TOC 페이지 재번역
- [ ] 결과 비교
- [ ] 성능 측정

---

## 🎯 예상 효과

| 항목 | 현재 | 예상 | 개선 |
|------|------|------|------|
| 성공률 | 97.1% | **98.6%+** | +1.5%p |
| TOC 처리 | 부분 | **완전** | 100% |
| 표 번역 품질 | 양호 | **우수** | +20% |
| 긴 텍스트 | 양호 | **우수** | +15% |

---

## 📦 필요한 라이브러리

```python
# 기존
import re
import json

# 추가 (필요시)
# pip install tabulate  # 표 처리
# pip install markdown  # Markdown 변환
```

---

## ⚠️ 주의사항

1. **청크 분할 시**
   - 너무 작게 나누면 컨텍스트 손실
   - 너무 크게 나누면 효과 없음
   - 최적 크기: 600-800자

2. **표 처리 시**
   - 구조가 복잡하면 실패 가능
   - 폴백 전략 필수
   - 원본 보존 옵션

3. **TOC 처리 시**
   - 계층 구조 정확히 파악
   - 페이지 번호 손실 방지
   - 특수 문자 처리

---

## 🚀 다음 단계

지금부터 Step 1부터 순차적으로 구현하겠습니다!
